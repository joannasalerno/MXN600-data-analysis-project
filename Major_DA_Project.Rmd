---
title: "MXN600 Major Data Anaysis Project"
author: "Joanna Salerno, Pavan Asopa, Sevin Nejadi, Fernanda Martins Giuriati"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The credit risk models our lending start up company uses are of the utmost importance to the functioning and ultimate success of the company. As we were recently acquired by a regional Australian bank, the success of our company also impacts the success of the bank. Recently, some of the bank's senior financial analysts have raised concerns about the credit risk models we have been using. They reviewed our models' performance benchmarks and feel as though our models are not suitable for use in a setting in which they are subject to strict regulatory requirements.

Thus, we have been tasked by the bank's management to rebuild our credit risk model from the ground up. As per management, our main objective is to use information known at the time of a loan application to build a model that predicts loan default. We will follow a standard statistical analysis process, which will be guided by the following questions:

1. How does this new model perform compared to the one used previously? How can it be expected to perform on new loan applications?
2. What are the important variables in this model and how do they compare to variables that are traditionally important for predicting credit risk in the banking sector?

Furthermore, management has consulted with an expert statistician, who has suggested we also account for variation in trends that may exist either between different jurisdictions or over time. The following questions will guide this second part of our analysis:

3. Can accounting for this variation (e.g., state/zip-code and time) improve performance benchmarks?
4. Are there any surprising differences in variables that are important for predicting credit risk?
5. Does credit risk change over time or between states? This is not something the bank has previously
investigated and results may inform modified loan policies in the future.

This report will document our entire analysis process, beginning with data exploration and cleaning, to model building and interpretations of our results.

# Setup

We will first load in the required libraries for our data exploration and analysis process.

```{r load_libraries, echo=FALSE}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(MASS)
library(GGally)
library(lme4)
library(lmerTest)
library(DHARMa)
library(pROC)
library(dplyr)
```

Next, we will load in our datasets. We have a total of 4:

(1) A training dataset that we will use to build and train our model
(2) A test dataset that we will use to test the fit of our model(s)
(3) A validation dataset that we will use to assess the performance of our model(s)
(4) An extended dataset that includes the necessary variables for us to account for variation such as location and time

```{r load_data}
train_data <- read.csv("benchmark_training_loan_data.csv")
test_data <- read.csv("benchmark_testing_loan_data.csv")
val_data <- read.csv("benchmark_validation_loan_data.csv")
extended <- read.csv("extendend_version_loan_data.csv")
```

# Exploratory Analysis

We will begin by exploring the available data to understand how each variable is distributed and to identify any potential data quality issues. We will also investigate the relationships between the different variables to see whether any variables are highly correlated with one another.

Note: For this exploration portion of our analysis, we will be using the training dataset.

We will first explore the training dataset to understand its structure and the variables it is comprised of.

```{r head_data}
head(train_data)
```

At first glance of the first 6 rows of this dataset, we notice there is a value of n/a in the employment length column. There are also a few zero values in a few columns. This will prompt us to further explore the data for any true missing values.

```{r data_dim}
dim(train_data)
```

The training dataset contains a total of 23,052 observations of 19 variables.

```{r data_structure}
str(train_data)
```

Upon further investigation of the structure of the training data, we can see that 14 of the 19 variables are currently of numeric type, and the remaining 5 variables are characters.

We will now remove variable X, which is the number of each record, from all datasets, as it is not necessary for this analysis.

```{r remove_X_from_datasets}
train_data <- train_data[, -1]
val_data <- val_data[, -1]
test_data <- test_data[, -1]
extended <- extended[, -1]
```

We will now further investigate each variable to determine whether there is any missing data or outliers.

```{r data_summary}
summary(train_data)
```

Included above is the numeric distributions of each of the included variables. Based on the above summary, it appears as though there may exist one or multiple outliers in a few variables: annual income, inquiries in the last 6 months, open accounts, revolving balances, and total accounts. However, we will need to further investigate the distribution of all variables to better visualize this to determine whether these actually appear to be outliers.

Before producing some exploratory plots, we will briefly explore the data to see whether there are missing values for us to handle.

```{r sum_na}
colSums(is.na(train_data))
```

Based on the above output, it appears as though this dataset does not contain any missing data in the form of NA values. Now, we will explore the n/a values present in the columns which include string data.

```{r string_na_sum}
sum(train_data == 'n/a')
```

```{r string_na_rows}
na_rows <- train_data %>% filter_all(any_vars(. %in% c('n/a')))
head(na_rows)
```

Based on the above output, there are a total of 591 n/a (string) in this dataset. These all appear to be from the employment length column. We will move forward and assume that this is not truly missing data, but rather, means that the applicant is not currently employed. We will further examine the distribution of each variable by creating exploratory plots, and this will further clarify the meaning of some of the values contained within each column of the dataset.

## Exploratory Plots
### Data Preparation

Before we can create exploratory plots, there are a few variables we will need to convert to factors. This will help us in creating our visualizations as well as conducting our analyses, so we can consider the selected variables as factors with different levels rather than simply strings.

Training dataset:
```{r convert_vars_to_factors_train}
train_data$term <- as.factor(train_data$term)
train_data$emp_length <- as.factor(train_data$emp_length)
train_data$home_ownership <- as.factor(train_data$home_ownership)
train_data$verification_status <- as.factor(train_data$verification_status)
train_data$purpose <- as.factor(train_data$purpose)
train_data$repay_fail <- as.factor(train_data$repay_fail)
```

Test dataset:
```{r convert_vars_to_factors_test}
test_data$term <- as.factor(test_data$term)
test_data$emp_length <- as.factor(test_data$emp_length)
test_data$home_ownership <- as.factor(test_data$home_ownership)
test_data$verification_status <- as.factor(test_data$verification_status)
test_data$purpose <- as.factor(test_data$purpose)
test_data$repay_fail <- as.factor(test_data$repay_fail)
```

Validation dataset:
```{r convert_vars_to_factors_val}
val_data$term <- as.factor(val_data$term)
val_data$emp_length <- as.factor(val_data$emp_length)
val_data$home_ownership <- as.factor(val_data$home_ownership)
val_data$verification_status <- as.factor(val_data$verification_status)
val_data$purpose <- as.factor(val_data$purpose)
val_data$repay_fail <- as.factor(val_data$repay_fail)
```

Now, we'd like to briefly check whether there is an imbalance in the cases of repay_fail.

```{r check_imbalance_data}
plot(train_data$repay_fail)
```

Despite the significant class imbalance (repay_fail==0 v. repay_fail==1) in the dataset, logistic regression still maintains its probabilistic nature. However, it's important to note that imbalanced data can affect the model's predictive performance, potentially leading to a bias towards the majority class.

### Variable Distributions

Now, we will create some plots to visualize the distributions of some of the variables in this dataset.

```{r plots_1}
p1 <- ggplot(data = train_data, aes(int_rate, fill = repay_fail)) +
  geom_histogram(binwidth=5)

p2 <- ggplot(data = train_data, mapping = aes(x = verification_status, y = annual_inc)) +
  geom_boxplot() +
  theme_bw()

p3 <- ggplot(data = train_data, mapping = aes(x = repay_fail, y = loan_amnt)) +
  geom_boxplot() +
  theme_bw()

p4 <- ggplot(data = train_data, mapping = aes(x = repay_fail, y = annual_inc)) +
  geom_boxplot() +
  theme_bw()

p5 <- ggplot(data = train_data, mapping = aes(x = annual_inc, y = loan_amnt)) +
  geom_point() +
  theme_bw()

ggarrange(p1, p2)
ggarrange(p3, p4)
ggarrange(p5)
```

Explanations: 

Plot1 is a histogram that displays the distribution of interest rates in the dataset. The bars in the histogram are filled based on whether the loan was repaid successfully or not, where fill colours represent the two categories 0 for no failure and 1 for failure of loan repayment. Based on the plot, a trend can be seen that as the interest rate increases so does the chances of loan repayment failures.

Plot2 is a boxplot that shows the distribution of annual incomes based on different verification statuses. Each box represent a category of verification status. Based on the plot, we can see that we have similar sized boxes for all three categories which suggests that the median income for applicants in these categories is relatively consistent. However, we can see the presence of outlier in all three verification_status categories indicating that there are individuals with very high income within each group.

Plot3 is a boxplot that compares the loan amounts for both successful and unsuccessful loan repayments. Based on the plot, it can be seen that the median loan amount for both categories of loan repayment status are more or less consistent. The presence of outlier in both categories indicates that there are individuals with very high loan amount within each group. 

Plot4 is a boxplot that compares annual income between successful and unsuccessful loan repayments. Based on the plot it can be seen that most individuals that successfully paid off their loans are more or less consistent with the ones who failed with an exception of outliers in both categories.

Plot5 is scatter plot that displays relationship annual income and loan amount. 

Now, we will visualize the distribution of each of the numeric variables in the dataset, using histograms:

```{r dist_plots_1}
numeric_vars <- c("loan_amnt", "annual_inc", "dti", "delinq_2yrs", "inq_last_6mths",
                  "open_acc", "pub_rec", "revol_util", "revol_bal", "total_acc",
                  "credit_age_yrs")
par(mfrow=c(3,4))
for (var in numeric_vars) {
  hist(train_data[[var]], main=var, xlab=var)
}
```

The above plots shows the distribution of the numeric variables within the dataset. These reveal that several variables, namely 'annual_inc,' 'delinq_2yrs,' 'inq_last_6mths,' 'pub_rec,' and 'revol_bal,' exhibit significant outliers, which can potentially impact the integrity of our analysis.

To address the presence of these outliers and to ensure the robustness of our subsequent statistical modeling, we have chosen to apply a scaling transformation to the numeric covariates in the dataset. The resulting scaled variables will enable us to conduct our analysis with a dataset that has been preprocessed to reduce the undue impact of outliers.

```{r dist_plots_2}
ggplot(train_data, aes(x = purpose)) +
  geom_bar() +
  labs(x = "Purpose", y = "Frequency") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

The above bar plot represents the frequency of each unique value in the purpose variable. From the plot, it can be seen that the most common reasons to take out loans are for debt consolidation, credit cards, other, and home improvement.

```{r dist_plots_3}
ggplot(train_data, aes(x = term, y = loan_amnt)) +
  geom_boxplot() +
  labs(x = "Term", y = "Loan Amount")
```

The above plot consists of two side-by-side boxplots, one for each loan term category. Each boxplot provides information about the distribution of loan amounts for its respective term category. Based on the plot, we can see that, on average, loans with 60-month terms have higher loan amounts than those with 36-month terms, which is an expected behaviour. Also, we can observe some outliers in the 36-month terms, which indicates that there are a few loan amounts which are significantly higher than the typical range of loan amounts for this term category.

Below, we create a correlation matrix of the numeric variables to help us understand the relationship between the different numeric variables.

```{r corr_matrix}
columns <- c("loan_amnt", "annual_inc", "dti", "delinq_2yrs", "inq_last_6mths", "open_acc", "pub_rec", "revol_util", "revol_bal", "total_acc", "credit_age_yrs","int_rate")
corr_matrix <- cor(train_data[columns], method = "pearson")
ggcorr(corr_matrix, hjust = 1, size = 3, color = "grey")
```

The correlation matrix (heatmap) reveals several noteworthy patterns:

Upon reviewing the correlation matrix, it becomes evident that certain features exhibit a high degree of positive correlation, such as "total_acc" and "open_acc." Additionally, "credit_age_yrs" and "total_acc," as well as "revol_util" and "int_rate," while not displaying correlations as strong as those between "total_acc" and "open_acc," still exhibit a notable level of correlation.

Following our examination of this matrix, each variable within pairs of highly correlated predictors will be analyzed while fitting models with the goal of identifying and refining the best model.

# New Credit Risk Model

Keeping our above exploratory analysis in mind, we also reviewed articles on the factors that traditionally impact an individual's credit risk, especially when applying for loans. Both [Understanding the Five Cs of Credit](https://www.investopedia.com/ask/answers/040115/what-most-important-c-five-cs-credit.asp) and [Top 5 Factors Affecting Credit Risk When Taking A Personal Loan](https://www.forbes.com/advisor/in/personal-loan/top-5-factors-affecting-credit-risk-when-taking-a-personal-loan/) discussed the same 5 major factors impacting credit risk: 1) capacity, 2) capital, 3) conditions, 4) collateral, and 5) character. Factors related to capacity include an individual's employment history and job stability, as well as their annual income. Debt to equity ratios are also assessed as part of capacity. Capital demonstrates an individual's net worth and allows them to list assets that could be used as a reserve in unforeseen circumstances. Lenders will look at current market conditions as well to assess the relative risk presented to the applicant in repaying the loan. Collateral includes assets an applicant may pledge as security to be used in the case that they fail to repay the loan. Finally, character encompasses many factors, including an individual's credit history (how long they have had credit for?), repayment history (are they typically paying on time or not?), any previous loan defaults, and derogatory records for the individual. These 5 factors have been cited in multiple financial resources as those most important in evaluating and determining an applicant's credit risk.

Taking the above research into consideration, as well as our exploratory analysis of the available data, we have been able to match up some of the variables within the available data with those cited as being traditionally important for determining credit risk. For example, we have annual income (*annual_inc*), employment length (*emp_length*), revolving balances (*revol_bal*), revolving utilization, (*revol_util*), and debt-to-income ratio (*dti*) variables which all relate to the first factor listed above, capacity. We do not seem to have any relevant data to account for capital, but perhaps interest rate (*int_rate*) may be an indication of some of the market conditions, as interest rates tend to be higher during financial crises or recessions. We also have home ownership (*home_ownership*), which includes whether an applicant owns a home or is renting, and this could be considered under the factor of collateral. Finally, the following variables may relate to the factor of character: their credit age (*credit_age_yrs*), which demonstrates part of their credit history; total accounts (*total_acc*), which may demonstrate credit usage; inquiries in the last 6 months (*inq_last_6mths*), which demonstrates the frequency the individual is applying for credit or conducting activities which require credit check inquiries; the number of 30+ days past-due incidences of delinquency for the past 2 years (*delinq_2yrs*); number of derogatory public records (*pub_rec*). Other variables that seem relevant and potentially important to provide more information on the requested loan within the context of the applicant include the loan's purpose (*purpose*), amount (*loan_amnt*), and term length (*term*). Finally, we feel as though verification status (*verification_status*) may be important, as this indicates whether an applicant's income was officially verified. If an application's income is verified, this may prove beneficial to their application. Thus, we have listed below the initial 16 variables we wish to further investigate in relation to credit risk:

annual_inc, emp_length, verification_status, dti, credit_age_yrs, home_ownership, total_acc, revol_bal, revol_util, int_rate, term, purpose, loan_amnt, inq_last_6mths, delinq_2yrs, pub_rec
                   
## Variable Standardization

Now, we'll move on to building our first model. We'll first need to standardize our numeric variables, because, as mentioned above, many of them have differing ranges and some include outliers. Scaling these numeric variables will allow for more accurate comparison so that all variables are on a similar scale.

Training dataset standardization:
```{r train_standardisation}
numeric_columns <- sapply(train_data, is.numeric)  # Identify numeric columns

# Scale the numeric columns while keeping column names
train_data[, numeric_columns] <- scale(train_data[, numeric_columns])

train_scaled_data <- train_data %>%
  mutate_if(is.numeric, scale)
```

Test dataset standardization:
```{r test_standardisation}
numeric_columns <- sapply(test_data, is.numeric)  # Identify numeric columns

# Scale the numeric columns while keeping column names
test_data[, numeric_columns] <- scale(test_data[, numeric_columns])

test_scaled_data <- test_data %>%
  mutate_if(is.numeric, scale)
```

Validation dataset standardization:
```{r val_standardisation}
numeric_columns <- sapply(val_data, is.numeric)  # Identify numeric columns

# Scale the numeric columns while keeping column names
val_data[, numeric_columns] <- scale(val_data[, numeric_columns])

val_scaled_data <- val_data %>%
  mutate_if(is.numeric, scale)
```

## Variable Selection

First, we have decided to perform stepwiseAIC to identify the most important predictors of loan default, from the list of 16 variables we identified above: annual_inc, emp_length, verification_status, dti, credit_age_yrs, home_ownership, total_acc, revol_bal, revol_util, int_rate, term, purpose, loan_amnt, inq_last_6mths, delinq_2yrs, and pub_rec. However, due to computing limitations, none of the group members succeeded in running it with a full model that includes interactions between variables. Instead, we decided to use the sum of variables as the full model.

```{r stepAIC}
# Full model for backwards selection:
full_model <- glm(repay_fail ~ loan_amnt + term + int_rate + emp_length + home_ownership + annual_inc +
                    verification_status + purpose + dti + delinq_2yrs + inq_last_6mths + open_acc +
                    pub_rec + revol_bal + revol_util + total_acc + credit_age_yrs,
                  data = train_scaled_data, family = "binomial")

# Model with no variables present for forwards selection:
null_model <- glm(data = train_scaled_data,
    formula = repay_fail ~ 1,
    family = "binomial")

# Perform backward and forward selection:
backward_sel_model <- stepAIC(full_model, direction = "backward", trace = 0)

forward_sel_model <- stepAIC(
  null_model,
  scope = formula(full_model),
  direction = "forward",
  trace = 0) # prevents automatic output of stepAIC function
```

Now, we can view the model formulas and AIC values to ultimately choose the best one:

```{r backward_formula}
formula(backward_sel_model)
```

```{r forward_formula}
formula(forward_sel_model)
```

```{r backward_aic}
AIC(backward_sel_model)
```

```{r forward_aic}
AIC(forward_sel_model)
```

Based on the above output, both models produced the same formula (same list of covariates), as well as the same AIC values ($AIC = 18160.57$). Thus, we can select either to move forward with. We will choose the backward selection model, and will print the formula below again for review.

```{r chosen_formula}
formula(backward_sel_model)
```

According to stepwiseAIC, the best predictors of repay_fail are term, int_rate, emp_length, annual_inc, purpose, inq_last_6mths, pub_rec, revol_bal, and revol_util. We will move forward with these covariates to fine tune a model that not only fits the data well but improves predictive performance compared to the credit risk model the bank has been using.

First, we'll create a model using the same exact formula suggested by stepAIC:

```{r fit_model1}
model1 <- glm(repay_fail ~ term + int_rate + emp_length + annual_inc + purpose + 
                inq_last_6mths + pub_rec + revol_bal + revol_util,
              data = train_scaled_data, family = "binomial")
```

Print the model's AIC:

```{r aic_model1}
AIC(model1)
```

As we already saw above and just reviewed, this model has an $AIC = 18160.57$. Next, we will add a few interactions between some of the covariates that make the most sense based on our credit risk research. Specifically, we want to investigate the interactions between:

* term and int_rate, as interest rate makes sense in the context of the length of time the interest is spread out over
* term and emp_length, as perhaps shorter terms may be less risky with more stable employment histories
* term and annual_inc, as perhaps shorter terms may be less risky with higher annual incomes
* term and purpose, as perhaps credit risk changes depending on the term and loan's purpose (perhaps longer term loans are more appropriate for typically longer term purposes)
* int_rate and emp_length, as perhaps higher interest rates may not be as risky for individuals with stable employment histories
* int_rate and annual_inc, as perhaps higher interest rates may not be as risky for individuals with higher annual incomes

```{r fit_model2}
model2 <- glm(repay_fail ~ term + int_rate + emp_length + annual_inc + purpose + 
                inq_last_6mths + pub_rec + revol_bal + revol_util + term * int_rate +
                term * emp_length + term * annual_inc + term * purpose +
                int_rate * emp_length + int_rate * annual_inc,
              data = train_scaled_data, family = "binomial")
```

Print the model's AIC:

```{r aic_model2}
AIC(model2)
```

The AIC of the new model is higher, with a value of 18171.08. This is to be expected, though, as this new model is penalized for having more covariates than the first model we fit. We will now perform a $\chi^2$-test to confirm whether the addition of these interactions are adding value to the model compared to the model without any interaction terms:

```{r anova_model1_model2}
anova(model1, model2, test = "Chisq")
```

As the $\chi^2$-test has a $p < 0.05$ ($p = 0.0037$), this provides us with enough evidence to reject the null hypothesis that model 1 without interactions and model 2 with interactions explain the same amount of variation in the data. In other words, model 2 is significantly better at explaining the variation in the data compared to model 1. Thus, we will consider interactions between covariates. However, we will now decrease the number of interactions in our model, as model 2 included quite a few interactions. We will only consider the interaction between term and interest rate, as it seems to make sense that these two covariates together would have a large impact on loan default risk. Furthermore, including fewer interactions will assist in our model's interpretability, so that it may ultimately be more useful to the bank. Our goal is twofold in that we want to build an improved model, but this model needs to also be easy to interpret and apply in context. Thus, we want to minimize the complexity of this new model as much as possible so that we can better communicate and interpret our findings, and so that the bank can more easily use and understand our model.

```{r fit_model3}
model3 <- glm(repay_fail ~ term + int_rate + emp_length + annual_inc + purpose +
                inq_last_6mths + pub_rec + revol_bal + revol_util + term * int_rate,
              data = train_scaled_data, family = "binomial")
```

Print the model's AIC:

```{r aic_model3}
AIC(model3)
```

The AIC of model 3 is lower than that of both model 1 and model 2. We will now conduct $\chi^2$-tests to confirm whether model 3 is significantly better at explaining the variation in the data than both model 1 and model 2.

Compare model 3 and model 1:
```{r anova_model1_model3}
anova(model1, model3, test = "Chisq")
```

Compare model 3 and model 2:
```{r anova_model2_model3}
anova(model2, model3, test = "Chisq")
```

As both $\chi^2$-tests have a $p < 0.05$, this indicates that model 3 is significantly better at explaining the variation in the data, as compared to both model 1 and model 2. Thus, for this reason, as well as the fact that model 3 should be relatively easy to interpret, especially in comparison with model 2, we will move forward with model 3.

```{r summary_model3}
summary(model3)
```

## Logit Link Function

Next, we will fit a model using the logit link function, with our final list of covariates from model 3.

```{r fit_logit}
fit_logit <- glm(repay_fail ~ int_rate + emp_length + annual_inc + purpose + 
                   inq_last_6mths + pub_rec + revol_bal + revol_util + term * int_rate,
                 data = train_scaled_data, family = "binomial")

AIC(fit_logit)
```

This model has the lowest AIC value we have received thus far, and this, as well as the results of our $\chi^2$-tests, indicate that this is the best model at the moment. Thus, we will proceed with this model.

```{r summary_fit_logit}
summary(fit_logit)
```

### Logit Model Goodness of Fit

Before we try to interpret this model's summary, we will first check the goodness-of-fit to determine whether this model is actually a good fit for the data. We will first look at the goodness-of-fit for "seen" data (using the training dataset).

```{r fit_logit_resid_seen}
# simulate residuals from the model:
res_logit_seen = simulateResiduals(fit_logit)

# plot observed quantile versus expected quantile to assess distribution fit, and
# predicted value versus standardised residuals for unmodelled pattern in the residuals
plot(res_logit_seen)
```

The above DHARMA residuals plots shows no sign of overdispersion. The distribution test (KS), dispersion test, and outlier test all are non-significant, which means there is evidence to suggest that the distribution of the simulated quantiles follows a uniform distribution. Additionally, in the second plot, the quantiles of the residuals (red lines) show a uniform pattern for predicted values.

Now, we will use the test dataset, or "unseen" data, to assess whether this model is still a good fit for unseen data.

```{r fit_logit_resid_unseen}
# first fit the model on unseen data (test dataset)
fit_logit_unseen <- glm(repay_fail ~ int_rate + emp_length + annual_inc + purpose + 
                          inq_last_6mths + pub_rec + revol_bal + revol_util + term * int_rate,
                        data = test_scaled_data, family = "binomial")

# simulate residuals from the model:
res_logit_unseen = simulateResiduals(fit_logit_unseen)

# plot observed quantile versus expected quantile to assess distribution fit, and
# predicted value versus standardised residuals for unmodelled pattern in the residuals
plot(res_logit_unseen)
```

As can be seen in the above residuals plots, once again, this model appears to be a good fit for the data. The QQ plot of residuals does not indicate any deviations from normality, overdispersion, or outliers in the residuals. In other words, it appears that this model is also a reasonable fit for unseen data, which helps us to validate that our model is appropriate.

### Logit Model: Performance

Next, we will analyse the performance of our logit model, including for prediction. After all, this is one of the main reasons we've been tasked with conducting this analysis.

We will first analyse the model's performance on "seen" data:

Training dataset ROC:
```{r train_roc}
# ROC curve on scaled train data 
prob_logit_train=predict(fit_logit,type=c("response"))
g <- roc(train_scaled_data$repay_fail ~ prob_logit_train)
AUC <- g$auc
AUC
Gini <- 2*(AUC - 1/2)
Gini
plot(g)
```

Now, we will assess this model's predictive performance on "unseen" data. In other words, we'll assess how well this model performs on predicting credit risk for new applicants.

Validation dataset ROC:
```{r val_roc}
# ROC curve on scaled validation data
prob_logit_val=predict(fit_logit,newdata=val_scaled_data,type=c("response"))
g <- roc(val_scaled_data$repay_fail ~ prob_logit_val)
AUC <- g$auc
AUC
Gini <- 2*(AUC - 1/2)
Gini
plot(g)
```

For "seen" data, our model has a $Gini=0.410$, which is much higher than that of the old model ($Gini=0.114$). For "unseen" data (using the validation dataset), our model has a $Gini=0.395$, which is also much higher than that of the old model ($Gini=0.110$). Additionally, the ROC curves for the new model on both seen and unseen data are positioned closer to the top-left corners compared to the old model. These findings collectively indicate that the new model is not only performing better than the old model on seen data, but also has better predictive performance to predict credit risk on unseen data for new applicants.

## Probit Link Function

Though we are quite happy with the above selected model (with a logit link function), we will now test whether using a probit link function changes the AIC or performance of our model.

```{r fit_probit}
fit_probit <- glm(repay_fail ~ int_rate + emp_length + annual_inc + purpose + inq_last_6mths +
                    pub_rec + revol_bal + revol_util + term * int_rate,
                  data = train_scaled_data, family = binomial("probit"))

AIC(fit_probit)
```

Review probit model goodness-of-fit:

```{r fit_probit_resid}
# simulate residuals from the model:
res_probit = simulateResiduals(fit_probit)

# plot observed quantile versus expected quantile to assess distribution fit, and
# predicted value versus standardised residuals for unmodelled pattern in the residuals
plot(res_probit)
```

As can be seen above, the model fit using the probit link function also appears to be a good fit for the data in that it does not indicate any deviations from normality, overdispersion, or outliers in the residuals.

### Probit Model: Performance

Now, we will assess the performance of the model fit using the probit link function for comparison against the logit link function model.

Training dataset:
```{r probit_train_roc}
# Probit model: ROC curve on scaled train data 
prob_probit_train=predict(fit_probit,type=c("response"))
g <- roc(train_scaled_data$repay_fail ~ prob_probit_train)
AUC <- g$auc
AUC
Gini <- 2*(AUC - 1/2)
Gini
plot(g)
```

Validation dataset:
```{r probit_val_roc}
# Probit model: ROC curve on scaled validation data 
prob_probit_val=predict(fit_probit,newdata = val_scaled_data,type=c("response"))
g <- roc(val_scaled_data$repay_fail ~ prob_probit_val)
AUC <- g$auc
AUC
Gini <- 2*(AUC - 1/2)
Gini
plot(g)
```

While the model fit with a probit link function has lower AIC than the model with a logit link function and similarly demonstrates goodness-of-fit for the data, the probit model has a slightly lower Gini score on the validation dataset (Logit model: $Gini=0.410$ on train, $Gini=0.395$ on validation vs. Probit model: $Gini=0.410$ on train, $Gini=0.394$). Thus, we'll consider the logit model as better than the probit model.

## Cloglog Link Function

Finally, we will test whether using a complementary log-log link function changes the AIC or performance of our model.

```{r fit_cloglog}
fit_cloglog <- glm(repay_fail ~ int_rate + emp_length + annual_inc + purpose + inq_last_6mths +
                     pub_rec + revol_bal + revol_util + term * int_rate,
                   data = train_scaled_data, family = binomial("cloglog"))

AIC(fit_cloglog)
```

Review cloglog model goodness-of-fit:

```{r fit_cloglog_resid}
# simulate residuals from the model:
res_cloglog = simulateResiduals(fit_cloglog)

# plot observed quantile versus expected quantile to assess distribution fit, and
# predicted value versus standardised residuals for unmodelled pattern in the residuals
plot(res_cloglog)
```

### Cloglog Model: Performance

Now, we will assess the performance of the model fit using the cloglog link function for comparison against the logit link function model.

Training dataset:
```{r cloglog_train_roc}
# Cloglog model: ROC curve on scaled train data 
prob_cloglog_train=predict(fit_cloglog,type=c("response"))
g <- roc(train_scaled_data$repay_fail ~ prob_cloglog_train)
AUC <- g$auc
AUC
Gini <- 2*(AUC - 1/2)
Gini
plot(g)
```

Validation dataset:
```{r cloglog_val_roc}
# Cloglog model: ROC curve on scaled validation data 
prob_cloglog_val=predict(fit_cloglog,newdata = val_scaled_data,type=c("response"))
g <- roc(val_scaled_data$repay_fail ~ prob_cloglog_val)
AUC <- g$auc
AUC
Gini <- 2*(AUC - 1/2)
Gini
plot(g)
```

As can be seen above, the model fit with the cloglog link function appears to be a good fit for the data, as there is no indication of non-normality, overdispersion, or outliers in the residuals. However, the cloglog model has a higher AIC than both the logit and probit models. Furthermore, the cloglog model has a slightly lower Gini score on the the training dataset (Logit model: $Gini=0.410$ on train, $Gini=0.395$ on validation vs. Cloglog model: $Gini=0.407$ on train, $Gini=0.395$).

Based on the comparisons conducted between the three different link functions for our GLM model, we will choose to use the model with the logit link function as our final model. This model demonstrated the best combination of AIC value and performance, including predictive performance on unseen data, compared to the other models.

## Calculate Odds Ratio and CI

Next, we will calculate the odds ratios and confidence intervals for our final model. As this model was fit using the logit link function, we can exponentiate the estimates to get the odds ratio for each covariate.

```{r odds_ratio_GLM}
summary_logit <- summary(fit_logit)

parameter_estimates <- summary_logit$coef[, "Estimate"]
standard_errors <- summary_logit$coef[, "Std. Error"]
p_values <- summary_logit$coef[, "Pr(>|z|)"]

# Calculate the odds ratios by exponentiating the parameter estimate values
odds_ratios <- exp(parameter_estimates)

# Calculate the confidence intervals for the odds ratios
lower_ci <- exp(parameter_estimates - 1.96 * standard_errors)  # 1.96 corresponds to a 95% confidence interval
upper_ci <- exp(parameter_estimates + 1.96 * standard_errors)

model_results <- data.frame(
  Estimate = parameter_estimates,
  OddsRatio = odds_ratios,
  LowerCI = lower_ci,
  UpperCI = upper_ci,
  p_value = p_values
)

# Display results in a table
knitr::kable(
  model_results,
  col.names = c("Estimate", "Odds Ratio", "Lower Bound (2.5%)", "Upper Bound (97.5%)", "p-value")
)
```

Displaying only those variables whose p-value < 0.05:

```{r sig_results}
# Filter rows where p-value is less than 0.05
significant_results <- model_results[model_results$p_value < 0.05, ]

# Print the significant results
knitr::kable(
  significant_results,
  col.names = c("Estimate", "Odds Ratio", "Lower Bound (2.5%)", "Upper Bound (97.5%)", "p-value")
)
```

### Interpretations

Listed below are interpretations of the covariates of our final model:

* The intercept or baseline refers to individuals who have been employed for less than one year, are seeking a car loan, and have a 36-month loan term when all other numeric predictors are equal to zero, and is statistically significant (95% CI: [0.08,0.13], $p < 2e-16$).

* For a one-unit increase in the interest rate, the odds of "repay_fail" occurring increase by a factor of approximately 1.57 (95% CI: [1.48,1.67], $p < 2e-16$). As can be seen by the low p-value, this is a very significant effect.

* For individuals with 1 to 10 plus years of employment, none of these employment lengths have a significant effect on the odds of "repay_fail" occurring compared to the reference category (less than one year). Their odds ratios are close to 1, and all $p > 0.05$, indicating that these employment lengths do not significantly impact the likelihood of loan repayment failure.

* For individuals with missing/unspecified employment lengths or unemployed individuals ("n/a"), the odds of "repay_fail" occurring increase by a factor of approximately 1.73 (95% CI: [1.37,2.19], $p = 4.11e-06$), compared to baseline (less than one year). This indicates that the absence of employment length information is associated with a higher likelihood of loan repayment failure.

* For a one-unit increase in annual income, the odds of "repay_fail" occurring decrease by a factor of approximately 0.71 (95% CI: [0.67,0.75], $p < 2e-16$).

* For loans with a stated purpose of "credit card", "debt consolidation", "educational", "home improvement", "house", "major purchase", "renewable energy", and "wedding", there is no significant effect on the odds of "repay_fail" occurring compared to the reference category (car). As all $p > 0.05$, these loan purposes do not significantly impact the likelihood of loan repayment failure.

     + For loans with a stated purpose of "medical", the odds of "repay_fail" occurring increase by a factor of approximately 1.83 (95% CI: [1.30-2.57], $p = 0.000502$), compared to the baseline (car).

    + For loans with a stated purpose of "moving", the odds of "repay_fail" occurring increase by a factor of approximately 1.65 (95% CI: [1.15,2.36], $p = 0.006978$), compared to baseline (car).

    + For loans with a stated purpose of "other", the odds of "repay_fail" occurring increase by a factor of approximately 1.58 (95% CI: [1.24,2.00], $p = 0.000211$), compared to baseline (car).

    + For loans with a stated purpose of "small business", the odds of "repay_fail" occurring increase by a factor of approximately 2.78 (95% CI: [2.15,3.59], $p = 5.80e-15$), compared to baseline (car).

    + For loans with a stated purpose of "vacation", the odds of "repay_fail" occurring increase by a factor of approximately 1.56 (95% CI: [1.01,2.43], $p = 0.047421$), compared to baseline (car). 

    + As mentioned above, the specific loan purposes of "medical," "moving," "other," "small_business", and "vacation" are all associated with a higher likelihood of loan repayment failure, as each had a statistically significant effect with a $p < 0.05$. The effect of small business loan purposes is the most significant with the smallest p-value, while vacation loan purposes have a lesser degree of effect.
 
* For a one-unit increase in the number of inquiries in past 6 months, the odds of "repay_fail" occurring increase by a factor of approximately 1.24 (95% CI: [1.20,1.28], $p < 2e-16$). As can be seen by the low p-value, this is a very significant effect.

* For a one-unit increase in the number of derogatory public records, the odds of "repay_fail" occurring increase by a factor of approximately 1.06 (95% CI: [1.03,1.10], $p = 0.000332$).

* For a one-unit increase in revolving balance, the odds of "repay_fail" occurring increase by a factor of approximately 1.10 (95% CI: [1.06,1.14], $p = 5.70e-06$).

* For a one-unit increase in revolving credit utilization, the odds of "repay_fail" occurring increase by a factor of approximately 1.12 (95% CI: [1.07,1.18], $p = 4.05e-07$).

* Having a 60-month loan term increases the odds of "repay_fail" occurring by a factor of approximately 1.67 (95% CI: [1.51,1.85], $p < 2e-16$), compared to the reference category (36-month loan term).

* The negative estimate for the interaction between interest rate and the 60-month term suggests that the effect of interest rate on "repay_fail" is less severe for loans with a 60-month term compared to the reference category of the 36-month term. In other words, while interest rate still has a significant impact on loan repayment on its own, its impact differs for loans with longer terms.

    + The interaction between interest rate and the 60-month loan term decreases the odds of "repay_fail" by a factor of approximately 0.90 (95% CI: [0.82,0.98], $p = 0.013086$), compared to baseline. The relationship between interest rate and loan repayment may differ depending on the term length, with the effect changing for longer-term loans.

## Odds Ratio Plot with CIs

Below, we will create a plot that depicts the odds ratio of repayment failure for our final GLM credit risk model, including confidence interval ranges. These estimates are all compared to the baseline, which includes the 36-month loan term, less than one year of employment, and the loan purpose of "car".

```{r odds_ratio_plot_GLM}
plot_data <- data.frame(
  Variable = rownames(model_results),
  OddsRatio = model_results$OddsRatio,
  LowerCI = model_results$LowerCI,
  UpperCI = model_results$UpperCI
)

ggplot(plot_data, aes(x = OddsRatio, xmin = LowerCI, xmax = UpperCI, y = Variable)) +
  geom_point(size = 3, color="red") +
  geom_errorbarh(height = 0.2, color = "blue") +
  xlim(c(0, max(plot_data$UpperCI + 1))) +  
  theme_minimal() +
  labs(x = "Odds Ratio", y = "Variable") +
  ggtitle("Odds Ratios of Repayment Failure for GLM")
```

## Accuracy and Confusion Matrix

Finally, we will create a confusion matrix to demonstrate our final model's performance of classifying whether applicants will default on their payments or not.

```{r accuracy_confmatrix_GLM}
confusion_glm <- ifelse(prob_logit_val > 0.5, "1", "0")
confusion_glm <- as.factor(confusion_glm)

require(caret)
cm <- confusionMatrix(data=confusion_glm,
                      reference=val_scaled_data$repay_fail,
                      positive="1")
cm
```

Included above is a confusion matrix, which depicts our model's true and false positive/negative rates when predicting on unseen (validation) data. This can be used to better understand how well the model predicts new credit applications in terms of how accurately it classifies new applicants. The confusion matrix shows that out of 7,683 applicants, 6,497 of them will not default and have been accurately classified as so, and 28 of them will default and have been accurately classified as so. However, using our model, 1,131 applicants are falsely classified as non-defaulters when in fact, they will default, and 27 applicants are falsely classified as defaulters when they will not default. 

## Part 1 Discussion

In summary, the goal of the first part of our analysis was to rebuild a credit risk model from the ground up. We began with an exploration of the available data, which made us aware of the rather large ranges of some of our numeric variables. Thus, we chose to standardise all of the numeric variables in the data so that they can be more easily and directly compared and that those variables with larger ranges would not be favoured by our model. We also converted the categorical variables within the data to factors to prepare for model building.

We conducted our own loan application and credit risk research, and the results of this, in conjunction with our exploratory analyses, ultimately led us to select an initial list of 16 variables: annual_inc, emp_length, verification_status, dti, credit_age_yrs, home_ownership, total_acc, revol_bal, revol_util, int_rate, term, purpose, loan_amnt, inq_last_6mths, delinq_2yrs, pub_rec. We then decided to run stepwiseAIC to extract a good model formula from these variables. StepwiseAIC provided us with the following model formula:

repay_fail ~ term + int_rate + emp_length + annual_inc + purpose + inq_last_6mths + pub_rec + revol_bal + revol_util

We then wanted to consider whether interactions between any of the variables were important or improved the model. So, we tested a few interactions between some of the variables. However, we ultimately did not want our model to include too many interaction terms to avoid unnecessary complexity, which would introduce more challenges in interpretations and later applications. So, we opted to only keep the interaction between interest rate and loan term, as this made the most logical sense to us. This is because an interest rate on its own does not mean much until it is combined with either a loan amount or a loan term, as an interest rate is applied in relation to an amount over a period of time. In this case, we chose to select loan term, as loan amount was not included in the formula provided by stepwiseAIC. This led us to our final model formula:

repay_fail ~ int_rate + emp_length + annual_inc + purpose + inq_last_6mths + pub_rec + revol_bal + revol_util + term * int_rate

We justified arriving at this model by conducting $\chi^2$-tests between different tested models to determine whether new models with different variables and interactions were significantly better at explaining the variability in the data. We then took a look at the goodness-of-fit of our selected model, and we were pleased to find that our model fit the data reasonably well. We produced residuals plots which did not indicate any deviations from normality, overdispersion, or outliers in the model residuals. In other words, these plots demonstrated that our model was a good fit for the data and did a relatively good job of explaining the variation in the data. We also compared the AIC values of our final chosen model with the other models we fit, and the chosen model has the lowest AIC value.

Just to be sure, we also tested different link functions with the same final model formula. We tested both a probit and complementary log-log link function. The probit model, while demonstrating a lower AIC value than the initial logit model, did not do as well in terms of prediction. Ultimately, we want our model to not only fit the data well, but also to do a good job of predicting whether applicants will default or not. The complementary log-log model had a higher AIC value than the initial logit model, and we chose to not assess its predictive performance because of this. Thus, we ultimately selected the logit link function as the best link function for our final model.

We produced receiver operating characteristic (ROC) curves and calculated Gini scores to test our model's performance. Our goal was to build a model that improved the ROC curve from those of the bank's previous models, so that the curve reached more towards the upper-left-hand corner of the graph area. This would mean that the model did a better job at correctly distinguishing between the classes of repayment (repay_fail == 1 vs repay_fail == 0). The Gini score is a numeric representation of the area under the ROC curve, which also indicates a model's classification performance.

In terms of our final model's performance, it does much better than the credit risk model the bank was previously using. While the previous models yielded a $Gini=0.114$ on the training (seen) dataset and a $Gini=0.110$ on the validation (unseen) dataset, our models produced a $Gini=0.410$ on the training dataset and a $Gini=0.395$ on the validation dataset. This demonstrates that our model both performs well on seen data and also demonstrates good predictive performance on new, unseen data.

Thus, in terms of answering the first question we set out to answer with our analysis (see below):

1. How does this new model perform compared to the one used previously? How can it be expected to perform on new loan applications?

We can say that our new model outperforms the one used previously. It does a relatively good job on new loan applications. As our confusion matrix demonstrated, out of 7,683 applicants included in the training dataset, 6,497 of them will not default and our model has accurately classified them as so, and 28 of them will default and have been accurately classified as so. However, our model falsely classified 1,131 applicants as non-defaulters and 27 applicants as defaulters. While there is still certainly room for improvement, this model is still performing much better than the previous model, so we have successfully addressed question 1.

In terms of the second question of our analysis (see below):

2. What are the important variables in this model and how do they compare to variables that are traditionally important for predicting credit risk in the banking sector?

Our model summary demonstrated that the important (and in this case, important means that the variables demonstrated a significant effect on the risk of loan repayment) variables for predicting credit risk are as follows:

* Interest rate
* Unspecified employment length (whether information is missing or the individual is unemployed)
* Annual income
* Loan purposes of medical, moving, small business, vacation or other
* Number of inquiries in the last 6 months
* Number of derogatory public records
* Revolving balance and utilization
* 60-month loan term
* Interest rate * 60-month loan term

Only two of the important covariates in our model were associated with a significant decrease in the risk of credit default: annual income, which was associated with a decreased risk of default by a factor of 0.71 (95% CI: [0.67,0.75], $p < 2e-16$), and the interaction between interest rate and the 60-month loan term, which was associated with a decreased risk of default by a factor of 0.90 (95% CI: [0.82,0.98], $p = 0.013086$). All other listed important covariates are associated with an increase in the risk of credit default. Of these, the covariates associated with the larger increased risks of credit default are: the loan purposes of small business, with an increased risk of default by a factor of 2.78 (95% CI: [2.15,3.59], $p = 5.80e-15$), and medical, with an increased risk of default by a factor of 2.78 (95% CI: [2.15,3.59], $p = 5.80e-15$). Applicants with a value of "n/a" for employment length, whether that means they are unemployed or simply did not provide this information, also had a relatively large increased risk of default compared to other covariates, by a factor of 1.73 (95% CI: [1.37,2.19], $p = 4.11e-06$).

We found the relationship between interest rate and loan term on loan default to be interesting. While on their own, both interest rate and the 60-month loan term were associated with an increase in the odds that an applicant will fail to repay, the interaction between these two variables was associated with a decrease in the odds of repayment failure. This indicates that the relationship between interest rate and loan repayment may differ depending on the term length, with the effect changing for longer-term loans.

We believe the important variables in our model generally make sense when considering the variables that are traditionally important when predicting credit risk in the banking sector, which we determined through conducting some research on our own. For example, in the banking sector, the "5 Cs" have been said to be important in determining an individual's credit risk, and these include: capacity, capital, conditions, collateral, and capital. Our final model's important variables include annual income, employment length, revolving balances, and revolving utilization, which are all related to an individual's capacity to repay a loan. Term may also play a role in capacity, as the term can be compared against an individual's income and employment stability, for example, to determine their capacity to repay during the term period. Interest rate also interacts with the term, and taken together, these can indicate to the bank how well an individual should be able to repay their loan. Interest rate may also indicate current market conditions to the bank, and the number of inquiries in the last 6 months as well as derogatory public records for an individual both play a role in determining character to the bank.

We were somewhat initially surprised by some of the significant loan purposes. We did not initially find much in the research that indicated the effect of loan purpose on application approval, but it does seem to make sense that expenses such as medical bills, particularly if medical expenses are ongoing and high, and small businesses, especially depending on the economy, might make it harder for an individual to repay a loan on time. Perhaps the purpose of other is associated with an increase in risk of repayment failure, as individuals do not necessarily demonstrate that the purpose is meant for the short term and temporary. Moving surprised us, but perhaps if moving expenses are so astronomical and individuals are moving a long distance and getting set up with new jobs in new cities, it may take a while to get back on their feet, thus potentially affecting their ability to repay on time during the transition period. Finally, the purpose of vacations was initially surprising, but if individuals are taking out loans to pay for their vacations, it potentially means that they do not have the funds in the first place to pay for vacation. Thus, they are spending money without necessarily showing that they have the means to pay it back.

Something that also surprised us was the factors that did not appear to be significant when building and assessing our new credit risk model. In particular, we were surprised that stepwiseAIC did not indicate debt to income ratio, loan amount, home ownership, or an individual's credit age in years to be part of the best model formula. We also thought that verification status might play an important role to the bank, so that they could have some assurance that an individual's reported annual income was actually correct. Furthermore, the number of 30+ days past-due incidences of delinquency for the past 2 years was not indicated by stepwiseAIC to be an important factor, though we initially thought it would be. For this model, we decided to build upon and tune the initial model provided by stepwiseAIC, and thus, we did not include these variables. However, we were surprised, as some, such as debt to income ratio, home ownership, and credit age, are variables traditionally used in the banking sector to help determine an individual's credit risk.

Now, we will move on to the second part of our analysis and extend the final model we have presented above.
 
# Extended Credit Risk Model

So far, we've been able to address management's concerns regarding the previous credit risk model and have presented a new model that performs much better. We have also identified some of the important variables for predicting credit risk and have compared these to the factors which are traditionally important within the banking sector. We are now going to address the second part of management's concerns, which includes using an extended version of the initial dataset. We will set out to answer whether accounting for variation in trends over jurisdiction (location) or time changes or even improves performance benchmarks. Management has previously never considered whether credit risk changes between different states or over time, so we will investigate this. We will choose to use the same basic model formula as that in our new credit risk model, but we will add in the modification of accounting for variations in location and time.

We'll first take a look at the structure of the extended dataset.

```{r str_extended}
str(extended)
```

## Data Preparation

Next, we'll need to once again convert the relevant variables to factors. This time, this will include the new variables of zip_code, addr_state, and earliest_cr_line, in addition to the variables converted in the first part of this analysis, as these will be used to account for variations in location (zip_code and addr_state) and time (earliest_cr_line):

```{r convert_vars_to_factors_ext}
extended$term <- as.factor(extended$term)
extended$emp_length <- as.factor(extended$emp_length)
extended$home_ownership <- as.factor(extended$home_ownership)
extended$verification_status <- as.factor(extended$verification_status)
extended$purpose <- as.factor(extended$purpose)
extended$repay_fail <- as.factor(extended$repay_fail)
extended$zip_code <- as.factor(extended$zip_code)
extended$addr_state <- as.factor(extended$addr_state)
extended$earliest_cr_line <- as.factor(extended$earliest_cr_line)

# create new location variable, which will nest zip codes within states
extended <- within(extended, location <- factor(as.factor(addr_state):zip_code))
```

```{r check_num_levels_random_effects}
# location
nlevels(extended$zip_code)
nlevels(extended$addr_state)
nlevels(extended$location) # includes zip nested within each state

# time
nlevels(extended$earliest_cr_line)
```

## Variable Standardisation

Once again, we need to standardise the numeric variables in the dataset:

```{r standardisation_ext}
numeric_columns <- sapply(extended, is.numeric)  # Identify numeric columns

# Scale the numeric columns while keeping column names
extended[, numeric_columns] <- scale(extended[, numeric_columns])

extended_scaled <- extended %>%
  mutate_if(is.numeric, scale)
```

## Fit Models

We will begin to fit a GLMM to address this part of our analysis. We will use the same general model formula in terms of the inclusion of the same covariates. What will differ is the inclusion of random effects in this extended model. We will include random effects to account for variation in time and applicant location. We begin by fitting a model with just the applicant's state as a random effect:

```{r extended_fit1}
fit_var_1 <- glmer(repay_fail ~ int_rate + emp_length + annual_inc + purpose +
                     inq_last_6mths + pub_rec + revol_bal + revol_util + term * int_rate +
                     (1|addr_state), data = extended_scaled, family = "binomial")
```

View first extended model summary:

```{r summary_fit_var_1}
summary(fit_var_1)
```

As can be seen above, this model has an AIC value of 30131.5. Next, we'll add in another random effect of time, which is included as the variable "earliest_cr_line":

```{r fit_var_2}
# fit_var_2 <- glmer(repay_fail ~ int_rate + emp_length + annual_inc + purpose +
#                      inq_last_6mths + pub_rec + revol_bal + revol_util + term * int_rate +
#                      (1|addr_state) + (1|earliest_cr_line), data = extended_scaled, family = "binomial")
```

Adding in time as a random effect caused a failed to converge warning. Thus, we will now increase the tolerance of this model to see if this helps:

```{r fit_var_3}
fit_var_3 <- glmer(repay_fail ~ int_rate + emp_length + annual_inc + purpose +
                     inq_last_6mths + pub_rec + revol_bal + revol_util + term * int_rate +
                     (1|addr_state) + (1|earliest_cr_line), data = extended_scaled, family = "binomial",
                   control = glmerControl(check.conv.grad = .makeCC("warning", tol = 3e-3, relTol = NULL)))
```

The model ran successfully, so we'll take a look at the summary:

```{r}
summary(fit_var_3)
```

The AIC value 30126.5, which is lower than that of the first extended model (fit_var_1). This indicates the new model with both added random effects of state and time is a better fit.

Now, we'll add in one more random effect, which is zip code. Once again, we will fit this model with an increased tolerance, compared to the default tolerance:

```{r fit_var_4}
fit_var_4 <- glmer(repay_fail ~ int_rate + emp_length + annual_inc + purpose +
                     inq_last_6mths + pub_rec + revol_bal + revol_util + term * int_rate +
                     (1|addr_state) + (1|earliest_cr_line) + (1|zip_code),
                   data = extended_scaled, family = "binomial",
                   control = glmerControl(check.conv.grad = .makeCC("warning", tol = 9e-3, relTol = NULL)))
```

Now we can view this model summary:

```{r summary_fit_var_4}
summary(fit_var_4)
```

Now, we'll try including just two random effects: earliest credit line (time), and then the new location factor we created earlier, which nests zip codes within each state, rather than having to include zip code and state separately:

```{r fit_var_5}
fit_var_5 <- glmer(repay_fail ~ int_rate + emp_length + annual_inc + purpose +
                     inq_last_6mths + pub_rec + revol_bal + revol_util + term * int_rate +
                     (1|location) + (1|earliest_cr_line),
                   data = extended_scaled, family = "binomial",
                   control = glmerControl(optimizer = "Nelder_Mead",
                                          check.conv.grad = .makeCC("warning", tol = 8e-3, relTol = NULL)))
```

View model summary:

```{r summary_fit_var_5}
summary(fit_var_5)
```

## Goodness-of-Fit

Now, before we begin to interpret these extended models and analyse their performance benchmarks, we will first analyse the goodness-of-fit of the model which has all 3 variables as separate random effects (time, state, and zip code) and of the model which has 2 variables as random effects (time and location, which consists of zip codes nested within states). We'll begin with the former model.

```{r gof_fit_var_4}
# simulate residuals from the model:
res_fit_var_4 = simulateResiduals(fit_var_4)

# plot observed quantile versus expected quantile to assess distribution fit, and predicted value versus standardised residuals for unmodelled pattern in the residuals
plot(res_fit_var_4)
```

As can be seen above, while this model does not indicate overdispersion or significant outliers in the residuals, there appears to be significant deviation from normality in the residuals, as seen by the significant KS test results on the left. Let's now consider the model with just 2 random effects: time and location, in which location consists of zip codes nested within states.

```{r gof_fit_var_5}
# simulate residuals from the model:
res_fit_var_5 = simulateResiduals(fit_var_5)

# plot observed quantile versus expected quantile to assess distribution fit, and predicted value versus standardised residuals for unmodelled pattern in the residuals
plot(res_fit_var_5)
```

As can be seen in the above plots, this model that includes location as a random effect of zip codes nested within states appears to be a better fit for the data. Now, there is no indication of significant deviations from normality, nor overdispersion or outliers in the residuals. This indicates to us that this model does a relatively good job of explaining the variation in the data. Thus, we will select this model to further analyse.

## Analyse Performance Benchmarks

Now, we can move on to analyse the selected model's performance benchmarks and can compare these to the final, new credit risk model we obtained in the first part of this analysis. We begin by creating a ROC curve and computing a Gini score for the chosen extended model.

```{r extended_roc}
# ROC curve on scaled extended data for fit_var_5
prob_ext=predict(fit_var_5,type=c("response"))
g <- roc(extended_scaled$repay_fail ~ prob_ext)
AUC <- g$auc
Gini <- 2*(AUC - 1/2)
AUC
Gini
plot(g, main = "Extended Model ROC Curve")
```

As can be seen in the above plot, the extended model has a $AUC=0.7183$ and $Gini=0.437$. This is an improved score from that of the model from the first part of our analysis, which had a $AUC=0.7052$ and $Gini=0.410$. It is important to note that for the above plot, we were only able to assess the performance of our model using "seen" data. Thus, the metrics we are comparing from the part 1 model are also those obtained using "seen" data (called training dataset). Based on our obtained AUC and Gini scores, we can say that our extended model does result in improved performance benchmarks, as this model is better able to predict loan repayment failure. In other words, accounting for variations in time and location improves our model's ability to predict whether applicants will default on their loans or not.

Now, we can further analyse the residuals of this extended model to understand the effect of variations in time and location on credit risk.

```{r fit_var_5_resid}
plot(residuals(fit_var_5),
     ylab = "Residuals")
```

The above plot is roughly what we would expect to see in terms of the distribution of residuals for a normally distributed binary variable (repay_fail is comprised of just 0s and 1s to indicate whether an applicant failed to repay or not). Now we can further assess the distribution of the random effects:

```{r fit_var_5_resid_2}
res <- ranef(fit_var_5)

hist(res$earliest_cr_line[,1])
hist(res$location[,1])
```

As can be seen in the above plots, the residuals for the random effects of both time and location appear to be roughly normally distributed, which indicates to us that the chosen model did is a relatively good fit for the data.

## Calculate Odds Ratio and CIs

As the selected model was fit with a logit link function, we can exponentiate the estimates for easier interpretations of the significant effects. We will also calculate confidence intervals and present everything in a table for review and further interpretation.

```{r odds_ratio_GLMM}
summary_fit5 <- summary(fit_var_5)

parameter_estimates2 <- summary_fit5$coef[, "Estimate"]
standard_errors2 <- summary_fit5$coef[, "Std. Error"]
p_values2 <- summary_fit5$coef[, "Pr(>|z|)"]

# Calculate the odds ratios by exponentiating the parameter estimate values
odds_ratios2 <- exp(parameter_estimates2)

# Calculate the confidence intervals for the odds ratios
lower_ci2 <- exp(parameter_estimates2 - 1.96 * standard_errors2)  # 1.96 corresponds to a 95% confidence interval
upper_ci2 <- exp(parameter_estimates2 + 1.96 * standard_errors2)

model_results2 <- data.frame(
  Estimate = parameter_estimates2,
  OddsRatio = odds_ratios2,
  LowerCI = lower_ci2,
  UpperCI = upper_ci2,
  p_value = p_values2
)

# Display results in a table
knitr::kable(
  model_results2,
  col.names = c("Estimate", "Odds Ratio", "Lower Bound (2.5%)", "Upper Bound (97.5%)", "p-value")
)
```

Displaying only those variables whose p-value is less than 0.05:

```{r}
# Filter rows where p-value is less than 0.05
significant_results2 <- model_results2[model_results2$p_value < 0.05, ]

# Print the significant results
knitr::kable(
  significant_results2,
  col.names = c("Estimate", "Odds Ratio", "Lower Bound (2.5%)", "Upper Bound (97.5%)", "p-value")
)
```

### Interpretations

Accounting for variation in time and location does have an impact on our model. In particular, accounting for this variation results in an addition of four newly significant covariates, which are all loan purpose categories:

* purpose == debt_consolidation

For loans with a stated purpose of debt consolidation, the odds of "repay_fail" occurring increase by a factor of approximately 1.24 (95% CI: [1.04-1.48], $p = 0.016010$), compared to the baseline (car).

* purpose == educational

For loans with a stated purpose of education, the odds of "repay_fail" occurring increase by a factor of approximately 2.03 (95% CI: [1.50-2.76], $p = 0.0000068$), compared to the baseline (car).

* purpose == home_improvement

For loans with a stated purpose of home improvement, the odds of "repay_fail" occurring increase by a factor of approximately 1.23 (95% CI: [1.00-1.50], $p = 0.0479871$), compared to the baseline (car).

* purpose == renewable_energy

For loans with a stated purpose of renewable energy, the odds of "repay_fail" occurring increase by a factor of approximately 1.82 (95% CI: [1.00-3.28], $p = 0.0470893$), compared to the baseline (car).

Beyond these differences, this extended model had the same general set of significant covariates and interactions, in the same directions, though the effect sizes and p-values may vary.

In summary, the full list of important variables in our extended model is as follows:

* Interest rate
* Unspecified employment length (whether information is missing or the individual is unemployed)
* Annual income
* Loan purposes of medical, moving, small business, vacation, other
    + debt consolidation, educational, home improvement, renewable energy (new with extended model)
* Number of inquiries in the last 6 months
* Number of derogatory public records
* Revolving balance and utilization
* 60-month loan term
* Interest rate * 60-month loan term

### Random Effects: Interpretations

Now, we can interpret the role of the random effects of our extended model, which are time and location (consists of zip code nested within each state).

```{r revisit_fit_var_5_summary}
summary(fit_var_5)
```

We can compare the variance of each random effect to determine which has a larger impact on an individual's credit risk, if any.

* Location: The location (addr_state:zip_code) random effect has a variance of 0.05114, meaning that the variation in applicants' locations explains about 5% of the variation in credit risk.

* Time: The time (earliest_cr_line) random effect has a variance of 0.01414, meaning that the variation in how long each applicant has had credit explains about 1% of the variation in credit risk.

If we compare the variance of each random effect, we'll see that location has a higher variance (0.05) than time (0.01). Thus, we can say that location has a larger impact on an applicant's credit risk, in comparison to time.

## Odds Ratio Plot with CIs

Below, we will create a plot that depicts the odds ratio of repayment failure for our final extended GLMM model, including confidence interval ranges. These estimates are all compared to the baseline, which includes the 36-month loan term, less than one year of employment, and the loan purpose of "car".

```{r odds_ratio_plot_GLMM}
plot_data <- data.frame(
  Variable = rownames(model_results2),
  OddsRatio = model_results2$OddsRatio,
  LowerCI = model_results2$LowerCI,
  UpperCI = model_results2$UpperCI
)

ggplot(plot_data, aes(x = OddsRatio, xmin = LowerCI, xmax = UpperCI, y = Variable)) +
  geom_point(size = 3, color="red") +
  geom_errorbarh(height = 0.2, color = "blue") +
  xlim(c(0, max(plot_data$UpperCI + 1))) +  
  theme_minimal() +
  labs(x = "Odds Ratio", y = "Variable") +
  ggtitle("Odds Ratios of Repayment Failure for GLMM")
```

## Accuracy and Confusion Matrix

Finally, we can assess how well our extended model performs in terms of classifying whether applicants will default on their payments or not.

```{r accuracy_confmatrix_GLMM}
confusion_glmm <- ifelse(prob_ext > 0.5, "1", "0")
confusion_glmm <- as.factor(confusion_glmm)

require(caret)
cm_glmm <- confusionMatrix(data=confusion_glmm,
                           reference=extended_scaled$repay_fail,
                           positive="1")
cm_glmm
```

Included above is a confusion matrix for our extended model, which we have built only based on "seen" data. It demonstrates that out of 38,419 applicants, 32,492 of them will not default and have been accurately classified as so, and 131 of them will default and have been accurately classified as so. However, using our extended model, 5,678 applicants are falsely classified as non-defaulters when in fact, they will default, and 118 applicants are falsely classified as defaulters when they will not default.

## Part 2 Discussion

In summary, the main goal of this second part of our analysis was to account for variations in location and time to determine whether this improves our model's performance benchmarks.

Specifically, below are the three questions we set out to answer in part 2 of this analysis:

3. Can accounting for this variation (e.g., state/zip-code and time) improve performance benchmarks?
4. Are there any surprising differences in variables that are important for predicting credit risk?
5. Does credit risk change over time or between states? This is not something the bank has previously
investigated and results may inform modified loan policies in the future.

In terms of question 3, we can say that yes, accounting for the variation in location and time does improve our model's performance benchmarks. Specifically, our extended model achieved a $Gini=0.437$, compared to the final model of the first part of our analysis, which had a $Gini=0.410$. This improved Gini score tells us that our extended model did a slightly better job at predicting whether applicants would fail to repay their loans or not.

In terms of question4, we were a bit surprised by the inclusion of 4 more significant covariates in our model, after accounting for this variation:

* Debt consolidation
* Educational
* Home improvement
* Renewable energy

Once again, all 4 were associated with an increased risk of repayment failure. Initially, debt consolidation and educational purposes made the most sense to us as being important factors contributing to credit risk, as typically, if an individual is consolidating their debt, they have a decent amount of it. Furthermore, educational expenses, especially in the United States, are rather high and many student loan borrowers are in a great deal of student loan debt. Thus, we are assuming that individuals seeking loans for the purposes of debt consolidation and education will be requesting higher loan amounts, which could be risky in terms of their ability to fully repay them.

However, home improvement and renewable energy loans surprised us as being significant, at least initially. When further considering these, though, we realized that typically, home improvement and the installation or switch to renewable energy are often associated with larger upfront costs, with delayed benefits. For example, when choosing to install solar panels on a home, prices can range between \$15,000.00 and \$20,000.00, though some homes may cost an upwards of \$25,000.00 for full installation ([How Much Do Solar Panels Cost? (2023 Guide)](https://www.marketwatch.com/guides/solar/solar-panel-cost/#:~:text=Based%20on%20our%20survey%20of,upward%20of%20%2425%2C000%20per%20installation.)). Furthermore, individuals typically do not begin to see the benefits in terms of decreased energy bills and savings for months to come, thus putting them at a greater initial risk of failing to repay their loan. Prices for education, home improvement, and renewable energy also tend to vary by location; educational expenses will vary based on desired locations and cost of living, as well as whether the school is public or private. In terms of home improvement and renewable energy, associated costs will depend on the market value of homes, as well as current prices of supplies and costs for contractors (if necessary). These all make more sense in the context of this part of our analysis, as we are now accounting for variations in location, thus potentially helping to explain why the above-listed covariates are newly significant in this extended model.

Finally, for the last question (question 5), credit risk does appear to change over time and between states. Credit risk changes more between states than time, as the variance for location was 0.05, compared to that for time, which was 0.01. Thus, location does seem to have a moderate impact on an individual's credit risk, and thus, the bank should consider location when assessing loan applications and policies.

# Conclusion

In summary, we have conducted a thorough analysis and built a new credit risk model from the ground up to address the bank's concerns regarding their previous models.

To review, below are the questions that guided our analyses:

1. How does this new model perform compared to the one used previously? How can it be expected to perform on new loan applications?
2. What are the important variables in this model and how do they compare to variables that are traditionally important for predicting credit risk in the banking sector?
3. Can accounting for this variation (e.g., state/zip-code and time) improve performance benchmarks?
4. Are there any surprising differences in variables that are important for predicting credit risk?
5. Does credit risk change over time or between states? This is not something the bank has previously
investigated and results may inform modified loan policies in the future.

Our new model has demonstrated significantly improved performance in comparison to the previous models, on both "seen" data and "unseen" data ($Gini=0.410$ on seen for new model versus $Gini=0.114$ on seen for old model). It is through the use of this "unseen" data that we were able to assess our new model's performance on new loan applications ($Gini=0.395$ on unseen for new model versus $Gini=0.110$ on unseen for old model). The important variables of our new model are:

* Interest rate
* Unspecified employment length (whether information is missing or the individual is unemployed)
* Annual income
* Loan purposes of medical, moving, small business, vacation, other
* Number of inquiries in the last 6 months
* Number of derogatory public records
* Revolving balance and utilization
* 60-month loan term
* Interest rate * 60-month loan term

These mostly align with the variables traditionally used to predict credit risk in the banking sector. A main deviation from tradition is that our new model excluded the variables of debt to income ratio, home ownership, and loan amount, which surprised us.

When we extended our new credit risk model to account for variations in location and time, we did see improved model performance benchmarks in that we received an improved Gini score ($Gini=0.437$ on extended versus $Gini=0.410$ on model without accounting for variation). We were only able to assess this model's performance on seen data, and could not assess it's predictive performance on new loan applications.

We were initially surprised by the addition of 4 newly significant covariates in our extended model, which were the loan purposes of debt consolidation, educational, home improvement, and renewable energy. However, given that the overall cost of many of these purposes will likely vary based on location, these actually do make sense in the context of our extended model.

Finally, we found that credit risk changes more over location than time, so this is a variable the bank should consider future loan applications and policies.

While our final model may not be the _best_ model, it is a _better_ model than the bank has previously used. Thus, we have adequately addressed the bank's concerns by presenting a model that does a better job of predicting loan default, and we hope the bank is delighted by our findings.

## Caveats

Though we have attempted to conduct a thorough and meaningful analysis to develop a new credit risk model that performs significantly better than those the bank was previously using, there are still a few caveats to our analyses. We have listed these below:

* We have only included a subset of the possible variables which may help to predict loan default, and there may be other variables that result in a better model with improved performance benchmarks compared to the one we have presented in this report. In particular, we were surprised by the exclusion of certain variables, such as debt to income ratio, home ownership, and loan amount, which we initially assumed would be important for determining an individual's credit risk. Perhaps further investigation of these variables, along with others, may prove to be useful. The bank could even consider investigating interactions between more variables, but as discussed earlier in this report, we opted to avoid the inclusion of all but one possible interaction to prioritize the interpretability of our results. 
* Our extended model has a relatively high tolerance value, which could potentially be further reduced by tuning other model parameters. Furthermore, we have not been able to assess the extended model's predictive performance, as we did not have access to any unseen data that included the necessary variables to do so. Assessing predictive performance of the extended model may help to solidify evidence of this model's performance abilities.
* We do not know the time frame of the data that we have used to build and assess our models, and it might be helpful to know this to ensure that we use recent data for model building and prediction tasks. Obtaining the most up-to-date information would help to bolster confidence in the presented new models, as market conditions and the economy may be other factors that play a role in credit risk, and we have not accounted for those in our analyses.
* There is an imbalance within the repay_fail class, in that there exist many more cases of non-failure to repay, which might influence our model to favour that outcome. Thus, our results should be considered with this in mind.

## Future Directions

As mentioned above, further research could explore other variables and interactions between variables which were excluded in our analyses. This may further improve performance benchmarks the model's ability to predict whether applicants will fail to repay their loans or not. Furthermore, if provided with a validation dataset which included the extended variables of location and time, it may be useful to use the extended model to predict loan default on this "unseen" data and compare the extended model's prediction performance with that of the new model from the first part of our analysis. This could further validate whether the extended model improves performance benchmarks.

# Bibliography

Listed below are the references we consulted to conduct this analysis, including our research on credit risk as well as resources we consulted when addressing GLMM model convergence errors.

Choksi, N. (n.d.). Top 5 Factors Affecting Credit Risk When Taking a Personal Loan. Forbes.
  https://www.forbes.com/advisor/in/personal-loan/top-5-factors-affecting-credit-risk-when-taking-a-personal-loan/

CRAN. (n.d.-a). lme4 convergence warnings: Troubleshooting. R-Studio Pubs.
  https://rstudio-pubs-static.s3.amazonaws.com/33653_57fc7b8e5d484c909b615d8633c01d51.html

CRAN. (n.d.-b). Lme4 performance tips. CRAN - R Project.
  https://cran.r-project.org/web/packages/lme4/vignettes/lmerperf.html#:~:text=choice%20of%20optimizer,may%20be%20worth%20a%
  0try.

Segal, T. (n.d.). Understanding the Five Cs of Credit. Investopedia.
  https://www.investopedia.com/ask/answers/040115/what-most-important-c-five-cs-credit.asp

The R Foundation. (n.d.). Control of Mixed Model Fitting—R. R Documentation.
  https://search.r-project.org/CRAN/refmans/lme4/html/lmerControl.html

Wakefield, F. (2023, October 4). How Much Do Solar Panels Cost? (2023 Guide). MarketWatch.
  https://www.marketwatch.com/guides/solar/solar-panel-cost/#:~:text=Based%20on%20our%20survey%20of,upward%20of%20%2425%2C00
  %20per%20installation.
